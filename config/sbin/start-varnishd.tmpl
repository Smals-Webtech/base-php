#!/usr/bin/env bash

# ---------------------------------------------------------------------
# This script is autogenerated by the container startup script (gomplate)
# Purpose: wrap varnishd to ensure it uses the correct configuration
# ---------------------------------------------------------------------

set -euo pipefail

VARNISH_VCL_CONF="{{ .Env.VARNISH_VCL_CONF }}"
VARNISH_TTL="{{ .Env.VARNISH_TTL }}"
VARNISH_MIN_THREADS="{{ .Env.VARNISH_MIN_THREADS }}"
VARNISH_MAX_THREADS="{{ .Env.VARNISH_MAX_THREADS }}"
VARNISH_THREAD_TIMEOUT="{{ .Env.VARNISH_THREAD_TIMEOUT }}"

VARNISH_STORAGE_CONFIG=""
VARNISH_STORAGE_MALLOC_SIZE="{{ .Env.VARNISH_STORAGE_MALLOC_SIZE }}"
VARNISH_STORAGE_FILE_SIZE="{{ .Env.VARNISH_STORAGE_FILE_SIZE }}"

VARNISH_STORAGE_MALLOC_ENABLED="{{ .Env.VARNISH_STORAGE_MALLOC_ENABLED }}"
VARNISH_STORAGE_FILE_ENABLED="{{ .Env.VARNISH_STORAGE_FILE_ENABLED }}"

if [ "${VARNISH_STORAGE_MALLOC_ENABLED}" != "false" ]; then
	VARNISH_STORAGE_CONFIG="${VARNISH_STORAGE_CONFIG} -s malloc,${VARNISH_STORAGE_MALLOC_SIZE}"
fi

if [ "${VARNISH_STORAGE_FILE_ENABLED}" != "false" ]; then
	VARNISH_STORAGE_CONFIG="${VARNISH_STORAGE_CONFIG} -s file,/app/var/cache/varnish/storage.bin,${VARNISH_STORAGE_FILE_SIZE}"
fi

exec /usr/sbin/varnishd -F \
	-a 0.0.0.0:6081 \
	-f "${VARNISH_VCL_CONF}" \
	-T 0.0.0.0:6082 \
	-t "${VARNISH_TTL}" \
	-p "thread_pool_min=${VARNISH_MIN_THREADS}" \
	-p "thread_pool_max=${VARNISH_MAX_THREADS}" \
	-p "thread_pool_timeout=${VARNISH_THREAD_TIMEOUT}" \
	-S /app/var/cache/varnish/secret \
	-n /app/var/cache/varnish/varnishd \
	-P /app/var/run/varnish/varnishd.pid \
	"${VARNISH_STORAGE_CONFIG#" "}"
