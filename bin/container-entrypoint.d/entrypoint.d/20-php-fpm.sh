#!/usr/bin/env bash

# FastCGI Process Manager (FPM)

if [ -n "$PHP_FPM_REQUEST_MAX_MEMORY_IN_MEGABYTES" ]; then
	log "WARN" "PHP_FPM_REQUEST_MAX_MEMORY_IN_MEGABYTES is deprecated; please use PHP_MEMORY_LIMIT instead. PHP_FPM_REQUEST_MAX_MEMORY_IN_MEGABYTES will be ignored in future versions."
	PHP_MEMORY_LIMIT_WCMTECH_DEFAULT="${PHP_FPM_REQUEST_MAX_MEMORY_IN_MEGABYTES}M"
fi

PHP_FPM_REQUEST_MAX_MEMORY_IN_MEGABYTES_WCMTECH_DEFAULT="16"
CONTAINER_HEAP_PERCENT_WCMTECH_DEFAULT="0.80"

# Global Configuration

PHP_FPM_ERROR_LOG_WCMTECH_DEFAULT="/proc/self/fd/2"
PHP_FPM_LOG_LIMIT_WCMTECH_DEFAULT="8192" # https://github.com/docker-library/php/pull/725#issuecomment-443540114
PHP_FPM_LOG_LEVEL_WCMTECH_DEFAULT="notice"

# Pool Configuration

PHP_FPM_ACCESS_LOG_WCMTECH_DEFAULT="/proc/self/fd/2" # php-fpm closes STDOUT on startup, so sending logs to /proc/self/fd/1 does not work. (https://bugs.php.net/bug.php?id=73886)
PHP_FPM_ACCESS_FORMAT_WCMTECH_DEFAULT="%R - %u %t \\\"%m %r%Q%q\\\" %s %f %{milli}d %{kilo}M %C%%"

PHP_FPM_CLEAR_ENV_WCMTECH_DEFAULT="no"
PHP_FPM_LISTEN_MODE_WCMTECH_DEFAULT="0777"
PHP_FPM_LISTEN_ALLOWED_CLIENTS_WCMTECH_DEFAULT="127.0.0.1"

PHP_FPM_PM_WCMTECH_DEFAULT="ondemand"
PHP_FPM_PM_MAX_CHILDREN_WCMTECH_DEFAULT="40"
PHP_FPM_PM_PROCESS_IDLE_TIMEOUT_WCMTECH_DEFAULT="10s"
PHP_FPM_PM_MAX_REQUESTS_WCMTECH_DEFAULT="0"

if [ -n "$PHP_FPM_MAX_CHILDREN" ]; then
	log "WARN" "PHP_FPM_MAX_CHILDREN is deprecated; please use PHP_FPM_PM_MAX_CHILDREN instead. PHP_FPM_MAX_CHILDREN will be ignored in future versions."
	PHP_FPM_PM_MAX_CHILDREN_WCMTECH_DEFAULT="${PHP_FPM_MAX_CHILDREN}"
fi

PHP_FPM_CATCH_WORKERS_OUTPUT_WCMTECH_DEFAULT="yes"
PHP_FPM_DECORATE_WORKERS_OUTPUT_WCMTECH_DEFAULT="no"

true
